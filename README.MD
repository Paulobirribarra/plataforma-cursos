# Plataforma de Cursos - Asesorias Futuro LTD

Proyecto **Plataforma de Cursos**, una aplicaci√≥n web para gestionar y mostrar cursos en l√≠nea, construida con Django y PostgreSQL.

## Requisitos Previos

- Python 3.11 o superior
- Git
- PostgreSQL instalado y configurado (con un usuario `postgres` y base de datos `plataforma_cursos`)
- Un entorno virtual (recomendado)
- PowerShell (para el script de reinicio en Windows)

## Dependencias Principales

El proyecto utiliza las siguientes dependencias clave:

### Framework y Base de Datos
- **Django 5.2.1** - Framework web principal
- **psycopg2-binary 2.9.10** - Adaptador PostgreSQL
- **python-decouple 3.8** - Manejo de variables de entorno

### Sistema de Pagos
- **transbank-sdk 6.0.0** - SDK oficial de Transbank para Webpay
- **requests 2.28.2** - Cliente HTTP para APIs

### UI y Templates
- **django-widget-tweaks 1.5.0** - Personalizaci√≥n de formularios
- **django-allauth 65.8.0** - Sistema de autenticaci√≥n avanzado
- **pillow 11.2.1** - Procesamiento de im√°genes

### Otras Dependencias
Ver archivo `requirements.txt` para la lista completa.

## üõ°Ô∏è Sistema de Seguridad Integral

Este proyecto cuenta con un **sistema de seguridad de nivel empresarial** completamente implementado:

### **Caracter√≠sticas Principales**
- üîê **Decoradores granulares** por roles (superuser, admin, staff)
- üõ°Ô∏è **Middleware de seguridad** con rate limiting inteligente
- üìù **Sistema de logging** con rotaci√≥n autom√°tica
- üíæ **Sistema de backup** integral para PostgreSQL
- üö® **Alertas autom√°ticas** por email
- üîç **Auditor√≠a completa** de accesos administrativos

### **Verificaci√≥n del Sistema**
```powershell
# Verificar que todo est√© funcionando
.\verificar_sistema.ps1

# O ejecutar directamente
python scripts\verificar_sistema_completo.py
```

### **Documentaci√≥n Completa**
- üìñ `documentacion/SISTEMA_SEGURIDAD_INTEGRAL.md` - Gu√≠a general
- üìä `documentacion/SISTEMA_LOGGING_COMPLETO.md` - Sistema de logging  
- üíæ `documentacion/SISTEMA_BACKUP_HOSTINGER.md` - Backup y restauraci√≥n
- üöÄ `documentacion/DESPLIEGUE_HOSTINGER_COMPLETO.md` - Despliegue en producci√≥n
- üéØ `documentacion/RESUMEN_FINAL_IMPLEMENTACION.md` - Resumen ejecutivo

**Estado: ‚úÖ 100% Implementado y probado**

## Instalaci√≥n

1. **Clona el repositorio**:

   ```bash
   git clone https://github.com/Paulobirribarra/plataforma-cursos.git
   cd plataforma-cursos
   ```

2. **Crea y activa un entorno virtual**:

   ```powershell
   python -m venv env
   .\env\Scripts\Activate.ps1
   ```

3. **Instala las dependencias**:

   ```powershell
   pip install -r requirements.txt
   ```

4. **Configura las variables de entorno**:
   Copia el archivo `.env.example` a `.env` y configura tus valores:

   ```powershell
   Copy-Item .env.example .env
   ```

   Edita el archivo `.env` con tus datos reales:

   ```env
   SECRET_KEY=tu_clave_secreta_super_segura_aqui
   DEBUG=True
   DATABASE_URL=postgresql://postgres:tu_contrase√±a@localhost:5432/plataforma_cursos
   DATABASE_PASSWORD=tu_contrase√±a
   EMAIL_HOST_USER=tu_email@gmail.com
   EMAIL_HOST_PASSWORD=tu_contrase√±a_de_aplicaci√≥n
   
   # Configuraci√≥n de Webpay (Transbank) - SDK v6.0.0
   WEBPAY_ENVIRONMENT=INTEGRATION  # Para desarrollo, PRODUCTION para producci√≥n
   # Para ambiente de integraci√≥n, las credenciales se configuran autom√°ticamente
   # Para producci√≥n, descomentar y configurar:
   # WEBPAY_COMMERCE_CODE=tu_codigo_de_comercio_aqui
   # WEBPAY_API_KEY=tu_api_key_aqui
   ```

5. **Configura PostgreSQL**:
   ```sql
   CREATE USER postgres WITH PASSWORD 'tu_contrase√±a';
   CREATE DATABASE plataforma_cursos OWNER postgres;
   ```

## Configuraci√≥n de Base de Datos y Migraciones

### Opci√≥n 1: Migraciones Manuales (Recomendado para desarrollo)

Para un mayor control sobre el proceso, ejecuta las migraciones manualmente en este orden:

```powershell
# 1. Eliminar migraciones existentes (si las hay)
Remove-Item usuarios\migrations\0*.py -ErrorAction SilentlyContinue
Remove-Item cursos\migrations\0*.py -ErrorAction SilentlyContinue
Remove-Item pagos\migrations\0*.py -ErrorAction SilentlyContinue
Remove-Item membresias\migrations\0*.py -ErrorAction SilentlyContinue
Remove-Item carrito\migrations\0*.py -ErrorAction SilentlyContinue

# 2. Generar migraciones en orden espec√≠fico (respetando dependencias)
python manage.py makemigrations usuarios      # Primero los usuarios
python manage.py makemigrations membresias    # Luego membres√≠as (depende de usuarios)
python manage.py makemigrations cursos        # Cursos (depende de usuarios y membres√≠as)
python manage.py makemigrations pagos         # Pagos (depende de usuarios)
python manage.py makemigrations carrito       # Carrito (depende de usuarios y cursos)

# 3. Aplicar todas las migraciones
python manage.py migrate

# 4. Crear superusuario
python manage.py createsuperuser --email admin@plataforma-cursos.local
```

### Opci√≥n 2: Script Automatizado (Solo para reinicio completo)

**‚ö†Ô∏è ADVERTENCIA: Este script elimina TODOS los datos existentes**

```powershell
.\reset_database.ps1
```

**¬øCu√°ndo usar cada opci√≥n?**

- **Migraciones manuales**: Para desarrollo normal, cambios incrementales
- **Script automatizado**: Solo para reiniciar completamente el proyecto o resolver problemas complejos de migraci√≥n

### Opci√≥n 3: Inicializaci√≥n desde cero

Si es la primera vez que configuras el proyecto:

```powershell
# 1. Crear y configurar la base de datos
psql -U postgres -c "DROP DATABASE IF EXISTS plataforma_cursos;"
psql -U postgres -c "CREATE DATABASE plataforma_cursos;"

# 2. Ejecutar migraciones en orden
python manage.py migrate                      # Migraciones de Django primero
python manage.py makemigrations usuarios
python manage.py migrate usuarios
python manage.py makemigrations membresias
python manage.py migrate membresias
python manage.py makemigrations cursos
python manage.py migrate cursos
python manage.py makemigrations pagos
python manage.py migrate pagos
python manage.py makemigrations carrito
python manage.py migrate carrito

# 3. Crear superusuario
python manage.py createsuperuser --email admin@plataforma-cursos.local
```

## Inicio del Servidor

```powershell
python manage.py runserver
```

Abre tu navegador en http://127.0.0.1:8000/ para ver la aplicaci√≥n.

## Acceso al Panel de Administraci√≥n

- URL: http://127.0.0.1:8000/admin/
- Email: admin@plataforma-cursos.local (o el que hayas configurado)
- Password: El que definiste al crear el superusuario

**Estructura del Proyecto**

- cursos/: Aplicaci√≥n principal para gestionar cursos.
- usuarios/: Aplicaci√≥n para manejar usuarios customizados.
- pagos/: Aplicaci√≥n para procesar pagos con Webpay (SDK v6.0.0).
- membresias/: Aplicaci√≥n para gestionar planes de membres√≠a.
- carrito/: Aplicaci√≥n para el carrito de compras.
- templates/: Plantillas HTML (base.html, home.html, etc.).
- static/: Archivos est√°ticos (im√°genes, CSS, JS).
- media/: Archivos multimedia subidos por usuarios.
- documentacion/: Gu√≠as t√©cnicas y de implementaci√≥n.
- tests/: Scripts de testing y validaci√≥n.

## Funcionalidades Principales

### üí≥ Sistema de Pagos (Webpay)
- **SDK oficial Transbank v6.0.0** integrado
- **Ambiente de integraci√≥n** configurado autom√°ticamente
- **Testing automatizado** de transacciones
- **Manejo de errores** robusto
- **Logging detallado** para debugging

### üéì Gesti√≥n de Cursos
- **Cursos premium y gratuitos**
- **Cursos de recompensa** por membres√≠as
- **Administraci√≥n avanzada** con interfaz moderna
- **Categorizaci√≥n** y filtrado

### üë• Sistema de Membres√≠as
- **Planes de membres√≠a** con diferentes beneficios
- **Acceso a cursos exclusivos**
- **Gesti√≥n autom√°tica** de estados

### üõí Carrito de Compras
- **Compras m√∫ltiples** (cursos + membres√≠as)
- **Pagos mixtos** (gratuitos y pagados)
- **Procesamiento autom√°tico** post-pago

### üîê Seguridad Avanzada
- **Usuario personalizado** con campos de seguridad
- **Bloqueo autom√°tico** de cuentas
- **Verificaci√≥n de email**
- **Seguimiento de IPs**

## Seguridad del Modelo de Usuario

El proyecto utiliza un modelo de usuario personalizado (`CustomUser`) que mejora la seguridad con:

### Caracter√≠sticas de Seguridad Implementadas:

- **Email como identificador √∫nico**: M√°s seguro que username
- **Campos adicionales de seguridad**:
  - `failed_login_attempts`: Contador de intentos fallidos
  - `account_locked_until`: Bloqueo temporal de cuenta
  - `last_login_ip`: Seguimiento de direcciones IP
  - `is_email_verified`: Verificaci√≥n de email obligatoria
  - `email_verification_token`: Token para verificaci√≥n

### Recomendaciones de Seguridad:

1. **Contrase√±as fuertes**: Usar contrase√±as con al menos 12 caracteres, may√∫sculas, min√∫sculas, n√∫meros y s√≠mbolos
2. **Verificaci√≥n de email**: Activar verificaci√≥n de email en producci√≥n
3. **Bloqueo de cuenta**: El sistema bloquea autom√°ticamente cuentas despu√©s de 5 intentos fallidos
4. **Variables de entorno**: Nunca subir archivos `.env` al repositorio
5. **HTTPS en producci√≥n**: Configurar SSL/TLS para el servidor de producci√≥n

### Script de Reinicio (reset_database.ps1)

**‚ö†Ô∏è ADVERTENCIA: Este script elimina TODOS los datos existentes**

Caracter√≠sticas del script:

- Reinicia completamente la base de datos PostgreSQL
- Elimina y recrea todas las migraciones
- Crea un superusuario con credenciales seguras
- Maneja el orden correcto de dependencias entre aplicaciones

**Credenciales del superusuario creado por el script**:

- Email: `admin@plataforma-cursos.local`
- Password: `Admin123!Dev`
- Nombre: `Administrador Sistema`

**Requisitos para ejecutar el script**:

- PowerShell (Windows)
- PostgreSQL configurado y ejecut√°ndose
- Variables de entorno configuradas en `.env`
- Entorno virtual activado

### Soluci√≥n de Problemas Comunes

**Error: "no existe la relaci√≥n usuarios_customuser"**

```powershell
# Ejecutar migraciones en orden espec√≠fico
python manage.py migrate contenttypes
python manage.py migrate auth
python manage.py makemigrations usuarios
python manage.py migrate usuarios
```

**Error: "Unable to copy venvlauncher.exe"**

```powershell
# Eliminar entorno virtual corrupto y crear uno nuevo
Remove-Item -Recurse -Force env
python -m venv env
.\env\Scripts\Activate.ps1
pip install -r requirements.txt
```

**Error: "App isn't loaded"**

```powershell
# Verificar que todas las apps est√°n en INSTALLED_APPS en settings.py
# Ejecutar migraciones una por una si es necesario
```

**Error: "cannot import name 'WebpayPlus'" (SDK Transbank)**

```powershell
# Verificar versi√≥n del SDK
pip show transbank-sdk

# Reinstalar si es necesario
pip uninstall transbank-sdk
pip install transbank-sdk==6.0.0
```

**Error: 401 Unauthorized en Webpay**

```powershell
# Verificar configuraci√≥n de ambiente
# En .env debe estar: WEBPAY_ENVIRONMENT=INTEGRATION

# Probar configuraci√≥n
python tests\test_webpay_sdk.py
```

## üîß Scripts de Utilidad

### Testing y Validaci√≥n
```powershell
# Probar SDK de Transbank
python tests\test_webpay_sdk.py

# Ejecutar todos los tests
python tests\run_tests.py

# Diagn√≥stico del sistema
python tests\diagnostic_vscode_fix.py
```

### Gesti√≥n de Datos
```powershell
# Poblar datos de prueba
.\poblar_datos.ps1

# Crear sistema completo de prueba
python scripts\crear_sistema_completo.py

# Poblar solo cursos
python scripts\poblar_cursos.py
```

## Datos de Prueba para Webpay (SDK v6.0.0)

Para realizar pruebas de pago en el ambiente de integraci√≥n de Webpay, utiliza los siguientes datos:

| Campo               | Valor                              |
| ------------------- | ---------------------------------- |
| N√∫mero de tarjeta   | 4051 8856 0044 6623                |
| Fecha de expiraci√≥n | Cualquier fecha futura (ej: 12/25) |
| CVV                 | 123                                |
| RUT                 | 11.111.111-1                       |
| Contrase√±a          | 123                                |

### üöÄ SDK de Transbank v6.0.0

El proyecto utiliza el **SDK oficial de Transbank v6.0.0** para la integraci√≥n con Webpay:

- **Configuraci√≥n autom√°tica** para ambiente de integraci√≥n
- **Credenciales oficiales** incluidas para desarrollo
- **Manejo autom√°tico** de headers y autenticaci√≥n
- **Testing integrado** con scripts de validaci√≥n

### üìã Verificaci√≥n R√°pida de Webpay

```powershell
# Probar configuraci√≥n de Webpay
python tests\test_webpay_sdk.py
```

**Resultado esperado:**
```
‚úÖ Webpay configurado correctamente
‚úÖ Transacci√≥n creada exitosamente
üéâ ¬°Todas las pruebas pasaron exitosamente!
```

## üìö Documentaci√≥n Detallada

### Gu√≠as de Implementaci√≥n
- **[Soluci√≥n Completa de Pagos](documentacion/SOLUCION_COMPLETA_PAGOS.md)** - Arquitectura y implementaci√≥n completa
- **[Gu√≠a R√°pida SDK Transbank](documentacion/GUIA_RAPIDA_SDK_TRANSBANK.md)** - Instalaci√≥n y configuraci√≥n en 5 minutos
- **[Datos de Prueba Webpay](documentacion/DATOS_PRUEBA_WEBPAY.md)** - Credenciales y datos de testing
- **[Notas T√©cnicas de Migraci√≥n](documentacion/NOTAS_TECNICAS_MIGRACION_SDK.md)** - Detalles t√©cnicos de la implementaci√≥n

### Testing y Verificaci√≥n
- **[Prueba de Flujo de Compra](documentacion/PRUEBA_FLUJO_COMPRA.md)** - Testing completo del sistema
- **Script de testing**: `tests/test_webpay_sdk.py`

**Importante**: El sistema utiliza el SDK oficial de Transbank v6.0.0. Para configuraci√≥n de desarrollo, solo necesitas establecer `WEBPAY_ENVIRONMENT=INTEGRATION` en tu archivo `.env`. Las credenciales de integraci√≥n se configuran autom√°ticamente.
